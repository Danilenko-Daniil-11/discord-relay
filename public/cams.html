<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>📷 Панель камер</title>
<style>
body{margin:0;font-family:Arial;color:#eee;display:flex;height:100vh;overflow:hidden;background:#111}
.sidebar{width:260px;background:#1a1a1a;border-right:2px solid #333;display:flex;flex-direction:column}
.sidebar h2{text-align:center;padding:12px;margin:0;border-bottom:2px solid #333;background:#222}
.cam-list{flex:1;overflow-y:auto}
.cam-item{padding:10px;cursor:pointer;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}
.cam-item:hover{background:#333}
.cam-item.online{color:#7CFC00}
.cam-item.offline{color:#ff5555}
.main{flex:1;display:flex;flex-direction:column}
.viewer{flex:1;display:flex;justify-content:center;align-items:center;background:#000;position:relative}
.viewer img{max-width:100%;max-height:100%;border-radius:8px}
.viewer h3{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.6);padding:5px 10px;border-radius:5px;margin:0}
.debug{height:120px;background:#181818;border-top:2px solid #333;overflow-y:auto;font-size:12px;padding:5px;color:#aaa}
.debug div{margin-bottom:4px}
</style>
</head>
<body>
<div class="sidebar">
<h2>📡 Камеры</h2>
<div id="camList" class="cam-list"></div>
</div>
<div class="main">
<div class="viewer">
<h3 id="camTitle">Выберите камеру</h3>
<img id="camImage" src="" alt="">
</div>
<div id="debugLog" class="debug"></div>
</div>

<script>
const camListDiv=document.getElementById("camList"),
      camTitle=document.getElementById("camTitle"),
      camImage=document.getElementById("camImage"),
      debugLog=document.getElementById("debugLog");

let ws,currentCam=null,cams={};

function logDebug(msg){
    const line=document.createElement("div");
    line.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
    debugLog.appendChild(line);
    debugLog.scrollTop=debugLog.scrollHeight;
}

function connectWS(){
    ws=new WebSocket(`wss://${location.host}/?camId=all`);
    ws.onopen=()=>logDebug("✅ WebSocket подключён");
    ws.onerror=e=>logDebug("❌ WS ошибка: "+e.message);
    ws.onclose=()=>{ logDebug("⚠️ WebSocket отключён, переподключение..."); setTimeout(connectWS,2000); };
    ws.onmessage=e=>{
        const {camId,screenshot}=JSON.parse(e.data);
        const now=Date.now();
        if(!cams[camId]) addCamera(camId);
        cams[camId].lastSeen=now;
        if(currentCam===camId){
            camImage.src="data:image/jpeg;base64,"+screenshot;
            camTitle.textContent=`📷 Камера: ${camId}`;
        }
    };
}

function addCamera(camId){
    const el=document.createElement("div");
    el.className="cam-item offline";
    el.textContent=camId;
    el.onclick=()=>{ 
        currentCam=camId; 
        camTitle.textContent=`📷 Камера: ${camId}`; 
        logDebug(`➡️ Выбрана камера ${camId}`);
    };
    camListDiv.appendChild(el);
    cams[camId]={el,lastSeen:0};
}

// Обновление статуса онлайн/оффлайн
setInterval(()=>{
    const now=Date.now();
    Object.entries(cams).forEach(([id,cam])=>{
        cam.el.className="cam-item "+(now-cam.lastSeen<10000?"online":"offline");
    });
},3000);

connectWS();
</script>
</body>
</html>
