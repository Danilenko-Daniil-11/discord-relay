<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Камеры</title>
<style>
body { font-family: sans-serif; background:#121212; color:#eee; }
h1 { text-align:center; }
#cams { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.cam-container { border:1px solid #444; padding:5px; text-align:center; }
.cam-container img { max-width:320px; border-radius:4px; }
#debug { position:fixed; bottom:0; left:0; right:0; background:#222; color:#0f0; font-size:12px; padding:4px; max-height:150px; overflow:auto; }
select { margin:10px; padding:5px; background:#222; color:#eee; border:1px solid #555; }
</style>
</head>
<body>
<h1>Камеры</h1>
<select id="camSelect"></select>
<div id="cams"></div>
<div id="debug"></div>

<script>
const camsDiv = document.getElementById('cams');
const debugDiv = document.getElementById('debug');
const camSelect = document.getElementById('camSelect');

let cams = {}; // camId -> img элемент

function log(msg){ debugDiv.innerText += msg+"\n"; debugDiv.scrollTop=debugDiv.scrollHeight; }

// Функция добавления камеры
function addCam(camId){
    if(cams[camId]) return;
    const div=document.createElement('div');
    div.className='cam-container';
    const label=document.createElement('div'); label.innerText=camId;
    const img=document.createElement('img'); img.id=camId;
    div.appendChild(label); div.appendChild(img); camsDiv.appendChild(div);
    cams[camId]=img;

    const option=document.createElement('option'); option.value=camId; option.innerText=camId;
    camSelect.appendChild(option);
}

// WebSocket
function connectWS(camId){
    const ws=new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}?camId=${camId}`);
    ws.onopen=()=>log(`WS подключен: ${camId}`);
    ws.onmessage=(event)=>{
        const data=JSON.parse(event.data);
        addCam(data.camId);
        cams[data.camId].src="data:image/jpeg;base64,"+data.screenshot;
    }
    ws.onclose=()=>{ log(`WS закрыт: ${camId}`); setTimeout(()=>connectWS(camId),2000); }
}

connectWS("all");

camSelect.addEventListener("change", ()=>{ const camId=camSelect.value; camsDiv.querySelectorAll(".cam-container").forEach(c=>c.style.display="none"); if(cams[camId]) cams[camId].parentElement.style.display="block"; });
</script>
</body>
</html>
